name: Updatable check

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:

    runs-on: ubuntu-latest

    outputs:
      upToDate: ${{ steps.update-version.outputs.upToDate }}
      newVer: ${{ steps.update-version.outputs.newVer }}
      oldVer: ${{ steps.update-version.outputs.oldVer }}
      fileName: ${{ steps.update-version.outputs.fileName }}
      url: ${{ steps.update-version.outputs.url }}

    steps:
      - uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.19

      - name: Update version
        id: update-version
        working-directory: ./actions/crow
        run: |
          go run -v ./...
          echo "upToDate=$(cat ../temp/up.to.date)" >> $GITHUB_OUTPUT
          echo "newVer=$(cat ../temp/ci.version)" >> $GITHUB_OUTPUT
          echo "oldVer=$(cat ../temp/curr.version)" >> $GITHUB_OUTPUT
          echo "fileName=$(cat ../temp/file.name)" >> $GITHUB_OUTPUT
          echo "url=$(cat ../temp/url)" >> $GITHUB_OUTPUT

  create:

    runs-on: ubuntu-latest
    needs: update
    if: needs.update.outputs.upToDate == 'false'

    steps:
      - uses: actions/checkout@v3
      - uses: tibdex/github-app-token@v1
        name: Generate token
        id: generate-token
        with:
          app_id: 242446
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Create Issue
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          NEW_VER: ${{needs.update.outputs.newVer}}
          OLD_VER: ${{needs.update.outputs.oldVer}}
          FILENAME: ${{needs.update.outputs.fileName}}
          URL: ${{needs.update.outputs.url}}
        with:
          filename: actions/issue-template/update-from-upstream.md
          update_existing: true
          search_existing: all
